CREATE DATABASE CMS;

CREATE TABLE USERS(
  USER_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 100 MINVALUE 1 MAXVALUE 1000000 CACHE 1 ),
  USER_FNAME VARCHAR(30) NOT NULL,
  USER_MNAME VARCHAR(30) NOT NULL,
  USER_LNAME VARCHAR(30) NOT NULL,
  USER_NUMBER VARCHAR(30) NOT NULL,
  USER_EMAIL VARCHAR(30) NOT NULL,
  USER_USERNAME VARCHAR(30) NOT NULL,
  USER_PASSWORD VARCHAR(30) NOT NULL,
  USER_IS_ADMIN BOOLEAN NOT NULL DEFAULT FALSE,
  USER_CREATED_AT DATE NOT NULL,
  USER_UPDATED_AT DATE NOT NULL,
  PRIMARY KEY (USER_ID)
);

CREATE TABLE RELATIVE (
  REL_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 100 MINVALUE 1 MAXVALUE 1000000 CACHE 1 ),
  REL_FNAME VARCHAR(30) NOT NULL,
  REL_MNAME VARCHAR(30) NOT NULL,
  REL_LNAME VARCHAR(30) NOT NULL,
  REL_DOB DATE NOT NULL,
  REL_DATE_DEATH DATE NOT NULL,
  REL_DATE_INTERMENT DATE NOT NULL,
  REL_DATE_EXHUMATION DATE NOT NULL,
  USER_ID INTEGER,
  PRIMARY KEY (REL_ID),
  FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID) ON UPDATE CASCADE
);

CREATE TABLE PLOT (
  PLOT_ID VARCHAR(30) GENERATED ALWAYS AS (PLOT_YARD || PLOT_ROW || CAST(PLOT_COL AS VARCHAR)) STORED,
  PLOT_COL INTEGER NOT NULL,
  PLOT_ROW VARCHAR (30) NOT NULL,
  PLOT_YARD VARCHAR (30) NOT NULL,
  PLOT_STATUS VARCHAR (30) NOT NULL,
  PLOT_DATE TIMESTAMP,
  PRIMARY KEY (PLOT_ID)
);

CREATE TABLE TRANSACTION (
  TRANS_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 100 MINVALUE 1 MAXVALUE 1000000 CACHE 1 ),
  TRANS_TYPE VARCHAR(10) NOT NULL,
  TRANS_STATUS VARCHAR(10) NOT NULL,
  TRANS_DATE DATE NOT NULL,
  USER_ID INTEGER,
  REL_ID INTEGER,
  PLOT_ID VARCHAR(30),
  PRIMARY KEY(TRANS_ID),
  FOREIGN KEY (USER_ID) REFERENCES USERS (USER_ID) ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (REL_ID) REFERENCES RELATIVE (REL_ID) ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (PLOT_ID) REFERENCES PLOT (PLOT_ID) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE RECORD (
  REC_ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 100 MINVALUE 1 MAXVALUE 1000000 CACHE 1 ),
  REC_LASTPAY_DATE DATE NOT NULL,
  REC_LASTPAY_AMOUNT NUMERIC(8,2) NOT NULL,
  REC_STATUS VARCHAR(30) NOT NULL,
  PLOT_ID VARCHAR(30),
  REL_ID INTEGER,
  USER_ID INTEGER,
  PRIMARY KEY (REC_ID),
  FOREIGN KEY (USER_ID)  REFERENCES USERS(USER_ID),
  FOREIGN KEY (REL_ID) REFERENCES RELATIVE (REL_ID) ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (PLOT_ID) REFERENCES PLOT (PLOT_ID) ON UPDATE CASCADE ON DELETE CASCADE
);



TRIGGERS
=========================================================================================

CREATE OR REPLACE FUNCTION update_rel_date_exhumation()
    RETURNS TRIGGER AS
$$
BEGIN
    NEW.rel_date_exhumation := NEW.rel_date_death + INTERVAL '5 years';
    RETURN NEW;
END;
$$
LANGUAGE PLPGSQL;

CREATE TRIGGER trgr_update_rel_date_exhumation
    BEFORE INSERT ON RELATIVE
    FOR EACH ROW
    EXECUTE FUNCTION update_rel_date_exhumation();



ALTER TABLE RECORD
ALTER COLUMN rec_lastpay_date NOT NULL,
ALTER COLUMN rec_lastpay_amount NOT NULL;

UPDATE RECORD
SET rec_lastpay_date  = CURRENT_DATE,
SET rec_lastpay_amount = 500.00
WHERE REC_ID = 105;


=========================================================================================


FUNCTION

=========================================================================================

CREATE OR REPLACE FUNCTION delete_pending_records()
  RETURNS VOID AS
$BODY$
DECLARE
    current_date_time TIMESTAMP := NOW();
    one_week_interval INTERVAL := INTERVAL '1 week';
BEGIN
    UPDATE PLOT
    SET plot_status = 'Available'
    WHERE plot_id IN (
        SELECT p.plot_id
        FROM PLOT p
        INNER JOIN TRANSACTION t ON p.plot_id = t.plot_id
        WHERE t.trans_status = 'Pending'
        AND t.trans_date < current_date_time - one_week_interval
    ) AND plot_id NOT IN (
        SELECT p.plot_id
        FROM TRANSACTION t
        INNER JOIN PLOT p ON p.plot_id = t.plot_id
        WHERE t.trans_type = 'Booked'
    );

    DELETE FROM RELATIVE
    WHERE rel_id IN (
        SELECT r.rel_id
        FROM RELATIVE r
        INNER JOIN TRANSACTION t ON r.rel_id = t.rel_id
        WHERE t.trans_status = 'Pending'
        AND t.trans_date < current_date_time - one_week_interval
    ) AND rel_id NOT IN (
        SELECT r.rel_id
        FROM TRANSACTION t
        INNER JOIN RELATIVE r ON r.rel_id = t.rel_id
        WHERE t.trans_type = 'Booked'
    );

    UPDATE TRANSACTION
    SET trans_status = 'Cancelled'
    WHERE trans_status = 'Pending'
    AND trans_date < current_date_time - one_week_interval;
END;
$BODY$
LANGUAGE plpgsql;

